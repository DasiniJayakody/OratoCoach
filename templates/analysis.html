{% extends "base.html" %}

{% block title %}Analysis Selection - OratoCoach{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold mb-3">Select Your Analysis</h1>
                <p class="lead text-muted">
                    Choose which aspects of your presentation you'd like to analyze. You can select one, multiple, or all analyses.
                </p>
            </div>
            
            <!-- 1. SELECTION SECTION -->
            <div class="row g-4 mb-5">
                <div class="col-md-4">
                    <div class="analysis-card text-center" data-analysis="face">
                        <div class="analysis-icon text-primary">
                            <i class="fas fa-eye"></i>
                        </div>
                        <h4 class="fw-bold mb-2">Face Analysis</h4>
                        <p class="text-muted mb-3">Eye contact and facial engagement analysis</p>
                        <div class="form-check d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" id="face-check" value="face">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="analysis-card text-center" data-analysis="hands">
                        <div class="analysis-icon text-primary">
                            <i class="fas fa-hands"></i>
                        </div>
                        <h4 class="fw-bold mb-2">Hands Analysis</h4>
                        <p class="text-muted mb-3">Gesture detection and classification</p>
                        <div class="form-check d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" id="hands-check" value="hands">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="analysis-card text-center" data-analysis="pose">
                        <div class="analysis-icon text-primary">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h4 class="fw-bold mb-2">Pose Analysis</h4>
                        <p class="text-muted mb-3">Posture and movement tracking</p>
                        <div class="form-check d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" id="pose-check" value="pose">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-5">
                <button id="start-analysis" class="btn btn-primary btn-lg" disabled>
                    <i class="fas fa-play me-2"></i>Start Analysis
                </button>
            </div>
            
            <!-- 2. LOADING GENERATED REPORT SECTION -->
            <div id="analysis-status" class="mt-5" style="display: none;">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="loading-spinner mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <h5 class="card-title">Analysis in Progress</h5>
                        <p class="card-text text-muted">
                            Please present naturally while our AI analyzes your performance. 
                            This may take a few minutes depending on your selected analyses.
                        </p>
                        <div id="selected-analyses-display" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Report Generation Section -->
            <div id="report-section" class="mt-5" style="display: none;">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-file-pdf me-2 text-primary"></i>
                            Generate Your Report
                        </h5>
                        <p class="card-text text-muted mb-4">
                            Your analysis is complete! Generate a comprehensive PDF report with your results and recommendations.
                        </p>
                        
                        <!-- Report Generation Status -->
                        <div id="report-status" class="mb-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="report-status-text">Ready to generate your report</span>
                            </div>
                        </div>
                        
                        <!-- Report Generation Progress -->
                        <div id="report-progress" class="mb-4" style="display: none;">
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progress-bar">
                                    <span id="progress-text">0%</span>
                                </div>
                            </div>
                            <p class="text-muted" id="progress-message">Initializing report generation...</p>
                        </div>
                        
                        <!-- Report Actions -->
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <button id="generate-report-btn" class="btn btn-success btn-lg" onclick="generateReport()">
                                <i class="fas fa-file-pdf me-2"></i>Generate Report
                            </button>
                            <button id="view-report-btn" class="btn btn-primary btn-lg" onclick="viewReport()" style="display: none;">
                                <i class="fas fa-eye me-2"></i>View Report
                            </button>
                            <a id="download-report-btn" href="#" class="btn btn-outline-primary btn-lg" style="display: none;">
                                <i class="fas fa-download me-2"></i>Download Report
                            </a>
                            <button id="test-report-btn" class="btn btn-outline-warning btn-lg" onclick="testReport()" style="display: none;">
                                <i class="fas fa-cog me-2"></i>Test Report
                            </button>
                        </div>
                        
                        <!-- Previous Report Section -->
                        <div id="previous-report-section" class="mt-4" style="display: none;">
                            <hr class="my-4">
                            <div class="alert alert-secondary text-center">
                                <i class="fas fa-history me-2"></i>
                                <strong>Previous Test Report Available!</strong> You can view or download your previous analysis report below.
                            </div>
                            <div class="d-flex justify-content-center gap-3 flex-wrap">
                                <button id="view-previous-report-btn" class="btn btn-outline-info btn-lg" onclick="viewPreviousReport()" style="display: none;">
                                    <i class="fas fa-eye me-2"></i>View Previous Report
                                </button>
                                <a id="download-previous-report-btn" href="#" class="btn btn-outline-info btn-lg" style="display: none;">
                                    <i class="fas fa-download me-2"></i>Download Previous Report
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 3. NEW ANALYSIS SECTION -->
            <div class="card mt-5">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-redo me-2 text-secondary"></i>
                        Start New Analysis
                    </h5>
                    <p class="card-text text-muted mb-3">
                        Ready to analyze another presentation? Reset and start fresh.
                    </p>
                    <button id="new-analysis-btn" class="btn btn-outline-secondary btn-lg" onclick="resetAnalysis()">
                        <i class="fas fa-redo me-2"></i>New Analysis
                    </button>
                </div>
            </div>
            
            <!-- 4. VIEW PREVIOUS REPORT SECTION (moved to bottom) -->
            <div class="card mt-5">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-file-pdf me-2 text-primary"></i>
                        View Previous Report
                    </h5>
                    <p class="card-text text-muted mb-3">
                        View your previously generated presentation summary report
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <button id="view-pdf-btn" class="btn btn-primary btn-lg" onclick="viewPdfReport()">
                            <i class="fas fa-eye me-2"></i>View PDF Report
                        </button>
                        <a id="download-pdf-btn" href="/download_pdf" class="btn btn-outline-primary btn-lg" style="display: none;">
                            <i class="fas fa-download me-2"></i>Download PDF
                        </a>
                        <button id="check-pdf-btn" class="btn btn-outline-info btn-lg" onclick="checkPdfStatus()">
                            <i class="fas fa-info-circle me-2"></i>Check PDF Status
                        </button>
                    </div>
                    <div id="pdf-status-message" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfModalLabel">
                    <i class="fas fa-file-pdf me-2"></i>OratoCoach Presentation Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="pdf-iframe" src="" width="100%" height="600px" frameborder="0"></iframe>
            </div>
            <div class="modal-footer">
                <a href="#" id="modal-download-btn" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download Report
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* Clean, single script to manage selection and start-analysis behavior.
   Replaces the previous duplicated / conflicted script block. */
document.addEventListener('DOMContentLoaded', () => {
    // Elements
    const analysisCards = Array.from(document.querySelectorAll('.analysis-card'));
    const checkboxes = Array.from(document.querySelectorAll('.analysis-card input[type="checkbox"], input[type="checkbox"]'));
    const startButton = document.getElementById('start-analysis');
    const analysisStatus = document.getElementById('analysis-status');
    const reportSection = document.getElementById('report-section');
    const selectedAnalysesDisplay = document.getElementById('selected-analyses-display');

    // Helpers
    function getSelectedAnalyses() {
        return Array.from(document.querySelectorAll('.analysis-card input[type="checkbox"]'))
            .filter(cb => cb.checked)
            .map(cb => cb.value);
    }

    function setCardSelected(card, selected) {
        const cb = card.querySelector('input[type="checkbox"]');
        if (cb) cb.checked = !!selected;
        card.classList.toggle('selected', !!selected);
    }

    function updateStartButton() {
        const selected = getSelectedAnalyses();
        startButton.disabled = (selected.length === 0);
        startButton.innerHTML = selected.length > 0
            ? `<i class="fas fa-play me-2"></i>Start Analysis (${selected.length} selected)`
            : `<i class="fas fa-play me-2"></i>Start Analysis`;
    }

    // Init: ensure UI consistent
    analysisCards.forEach(card => {
        const cb = card.querySelector('input[type="checkbox"]');
        const initChecked = cb && cb.checked;
        card.classList.toggle('selected', !!initChecked);
    });
    updateStartButton();

    // Card click toggles checkbox (ignore clicks directly on checkbox to avoid double toggle)
    analysisCards.forEach(card => {
        card.addEventListener('click', (ev) => {
            if (ev.target && ev.target.tagName === 'INPUT') return;
            const cb = card.querySelector('input[type="checkbox"]');
            const newVal = !(cb && cb.checked);
            setCardSelected(card, newVal);
            updateStartButton();
        });
    });

    // Checkbox change updates card state and start button
    checkboxes.forEach(cb => {
        cb.addEventListener('change', (ev) => {
            const card = ev.target.closest('.analysis-card');
            if (card) card.classList.toggle('selected', ev.target.checked);
            updateStartButton();
        });
    });

    // Start analysis click handler
    startButton.addEventListener('click', () => {
        const selected = getSelectedAnalyses();
        if (selected.length === 0) {
            alert('Please select at least one analysis type.');
            return;
        }

        // UI: show status
        analysisStatus.style.display = 'block';
        startButton.disabled = true;

        const analysisNames = { face: 'Face Analysis', hands: 'Hands Analysis', pose: 'Pose Analysis' };
        selectedAnalysesDisplay.innerHTML = `
            <div class="alert alert-info">
                <strong>Selected Analyses:</strong><br>
                ${selected.map(a => analysisNames[a] || a).join(', ')}
            </div>`;

        // Start backend analysis
        fetch('/start_analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ analyses: selected })
        })
        .then(resp => resp.json())
        .then(data => {
            if (data && data.status === 'success') {
                pollAnalysisStatus();
            } else {
                analysisStatus.style.display = 'none';
                startButton.disabled = false;
                const msg = (data && data.message) ? data.message : 'Failed to start analysis';
                alert('Error starting analysis: ' + msg);
            }
        })
        .catch(err => {
            console.error('Start analysis error:', err);
            analysisStatus.style.display = 'none';
            startButton.disabled = false;
            alert('An error occurred while starting the analysis.');
        });
    });

    // Poll analysis status
    let pollInterval = null;
    function pollAnalysisStatus() {
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(() => {
            fetch('/analysis_status')
                .then(r => r.json())
                .then(data => {
                    // Update status UI (optional)
                    if (data.current_step) {
                        // show progress text if desired (kept minimal to avoid UI changes)
                        const progressTextEl = document.getElementById('progress-message');
                        if (progressTextEl) progressTextEl.textContent = data.current_step;
                    }
                    if (data.analysis_completed) {
                        clearInterval(pollInterval);
                        analysisStatus.style.display = 'none';
                        reportSection.style.display = 'block';
                        const rsText = document.getElementById('report-status-text');
                        const rsEl = document.getElementById('report-status');
                        if (rsText) rsText.textContent = data.pdf_generated ? 'Analysis completed and PDF generated.' : 'Analysis completed successfully! Ready to generate your report.';
                        if (rsEl) rsEl.className = data.pdf_generated ? 'alert alert-success' : 'alert alert-success';
                    }
                    if (data.error) {
                        clearInterval(pollInterval);
                        analysisStatus.style.display = 'none';
                        startButton.disabled = false;
                        alert('Analysis error: ' + data.error);
                    }
                })
                .catch(err => {
                    console.error('Polling error:', err);
                });
        }, 2000);
    }

    // Minimal implementations of helper functions (keep existing endpoints)
    window.checkPdfStatus = function() {
        const statusMessage = document.getElementById('pdf-status-message');
        const downloadBtn = document.getElementById('download-pdf-btn');
        if (statusMessage) statusMessage.innerHTML = '<div class="spinner-border spinner-border-sm text-primary me-2"></div>Checking PDF status...';
        fetch('/api/pdf_exists')
            .then(r => r.json())
            .then(data => {
                if (data.exists && (data.size || data.file_size || data.file_size > 0)) {
                    if (statusMessage) statusMessage.innerHTML = '<div class="alert alert-success mb-0"><i class="fas fa-check-circle me-2"></i>PDF report is available! You can view or download it.</div>';
                    if (downloadBtn) downloadBtn.style.display = 'inline-block';
                } else {
                    if (statusMessage) statusMessage.innerHTML = '<div class="alert alert-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>No PDF report found. Run an analysis first to generate a report.</div>';
                    if (downloadBtn) downloadBtn.style.display = 'none';
                }
            })
            .catch(err => {
                console.error('Error checking PDF:', err);
                if (statusMessage) statusMessage.innerHTML = '<div class="alert alert-danger mb-0">Error checking PDF status.</div>';
                if (downloadBtn) downloadBtn.style.display = 'none';
            });
    };

    window.checkPdfExists = function() {
        fetch('/api/pdf_exists')
            .then(r => r.json())
            .then(data => {
                if (data.exists && (data.size || data.file_size || data.file_size > 0)) {
                    document.getElementById('view-report-btn').style.display = 'inline-block';
                    document.getElementById('download-report-btn').style.display = 'inline-block';
                    document.getElementById('download-report-btn').href = '/download_pdf';
                    document.getElementById('modal-download-btn').href = '/download_pdf';
                    document.getElementById('report-status-text').textContent = 'Report generated successfully! You can now view or download it.';
                    document.getElementById('report-status').className = 'alert alert-success';
                    checkPdfStatus();
                } else {
                    document.getElementById('report-status-text').textContent = 'Report generation in progress... Please wait.';
                    setTimeout(checkPdfExists, 2000);
                }
            })
            .catch(err => console.error('checkPdfExists error', err));
    };

    window.generateReport = function() {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressMessage = document.getElementById('progress-message');
        const reportProgress = document.getElementById('report-progress');
        const generateBtn = document.getElementById('generate-report-btn');

        reportProgress.style.display = 'block';
        generateBtn.disabled = true;

        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 100) progress = 100;
            if (progressBar) progressBar.style.width = progress + '%';
            if (progressText) progressText.textContent = Math.round(progress) + '%';
            if (progress < 30) {
                if (progressMessage) progressMessage.textContent = 'Collecting analysis data...';
            } else if (progress < 60) {
                if (progressMessage) progressMessage.textContent = 'Generating charts and visualizations...';
            } else if (progress < 90) {
                if (progressMessage) progressMessage.textContent = 'Creating PDF report...';
            } else {
                if (progressMessage) progressMessage.textContent = 'Finalizing report...';
            }
            if (progress >= 100) {
                clearInterval(progressInterval);
                if (progressMessage) progressMessage.textContent = 'Report generated successfully!';
                setTimeout(() => { window.checkPdfExists(); }, 1000);
            }
        }, 200);

        fetch('/generate_pdf')
            .then(r => r.json())
            .then(data => {
                if (data.status !== 'success') {
                    if (progressMessage) progressMessage.textContent = 'Report generation failed: ' + (data.message || 'unknown');
                }
            })
            .catch(err => {
                console.error('generateReport error', err);
                if (progressMessage) progressMessage.textContent = 'Error generating report. Please try again.';
            });
    };

    window.viewPdfReport = function() {
        document.getElementById('pdf-iframe').src = '/view_pdf';
        document.getElementById('modal-download-btn').href = '/download_pdf';
        const modal = new bootstrap.Modal(document.getElementById('pdfModal'));
        modal.show();
    };

    window.resetAnalysis = function() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('.analysis-card').forEach(card => card.classList.remove('selected'));
        document.getElementById('analysis-status').style.display = 'none';
        document.getElementById('report-section').style.display = 'none';
        startButton.disabled = true;
        startButton.innerHTML = '<i class="fas fa-play me-2"></i>Start Analysis';
        document.getElementById('view-report-btn').style.display = 'none';
        document.getElementById('download-report-btn').style.display = 'none';
        const rptProg = document.getElementById('report-progress');
        if (rptProg) rptProg.style.display = 'none';
        const genBtn = document.getElementById('generate-report-btn');
        if (genBtn) genBtn.disabled = false;
        // attempt backend reset
        fetch('/reset_analysis').catch(() => {});
    };

    window.testReport = function() {
        fetch('/test_pdf').then(r => r.json()).then(d => {
            if (d.status === 'success') { alert('Test report created successfully.'); window.checkPdfExists(); }
            else alert('Test report failed: ' + (d.message || 'unknown'));
        }).catch(err => alert('Error: ' + err));
    };

    window.forceGenerateReport = function() {
        fetch('/force_generate_pdf').then(r => r.json()).then(d => {
            if (d.status === 'success') { alert('Force generation succeeded.'); window.checkPdfStatus(); }
            else alert('Force generation failed: ' + (d.message || 'unknown'));
        }).catch(err => alert('Error: ' + err));
    };

    window.checkPreviousReportExists = function() {
        fetch('/download_previous_pdf', { method: 'HEAD' })
            .then(response => {
                const el = document.getElementById('previous-report-section');
                if (response.ok && el) el.style.display = 'block';
            })
            .catch(() => {
                const el = document.getElementById('previous-report-section');
                if (el) el.style.display = 'none';
            });
    };

    // Initial checks
    if (typeof checkPdfStatus === 'function') checkPdfStatus();
    if (typeof window.checkPreviousReportExists === 'function') window.checkPreviousReportExists();
});
</script>
{% endblock %}